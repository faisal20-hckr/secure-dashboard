{% extends "layout.html" %}
{% block content %}
<div class="admin-dashboard">
    <h2>Admin Panel</h2>
    <div class="admin-stats">
        <div>Total Users: <b>{{ total_users }}</b></div>
        <div>Today's Logins: <b>{{ todays_logins }}</b></div>
        <div>Active Sessions: <b>{{ active_sessions }}</b></div>
    </div>
    <h3>User Management</h3>
    <table>
        <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Registered</th>
            <th>Profile Pic</th>
            <th>Actions</th>
        </tr>
        {% for user in users %}
        <tr>
            <td>{{ user['username'] }}</td>
            <td>{{ user['email'] }}</td>
            <td>
                <form method="post" action="{{ url_for('admin_set_role', user_id=user['id']) }}">
                    <select name="role" onchange="this.form.submit()" {% if user['role']=='admin' %}disabled{% endif %}>
                        <option value="user" {% if user['role']=='user' %}selected{% endif %}>User</option>
                        <option value="admin" {% if user['role']=='admin' %}selected{% endif %}>Admin</option>
                    </select>
                </form>
            </td>
            <td>{{ user['registered_at'] }}</td>
            <td>
                {% if user['profile_pic'] %}
                    <img src="{{ url_for('static', filename='profile_pics/'+user['profile_pic']) }}" style="width:32px;height:32px;border-radius:50%;">
                {% else %}
                    &mdash;
                {% endif %}
            </td>
            <td>
                {% if user['role'] != 'admin' %}
                <form method="post" action="{{ url_for('admin_delete_user', user_id=user['id']) }}" style="display:inline;">
                    <button type="submit" onclick="return confirm('Delete user?')">Delete</button>
                </form>
                {% else %}
                  &mdash;
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    <h3>Recent Login Activity</h3>
    <a href="{{ url_for('admin_export_csv') }}" class="btn">Export CSV</a>
    <table>
        <tr>
            <th>Username</th>
            <th>Login Time</th>
            <th>Device Info</th>
        </tr>
        {% for row in activity %}
        <tr>
            <td>{{ row['username'] }}</td>
            <td>{{ row['login_time'] }}</td>
            <td>{{ row['device_info'] }}</td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endblock %}
